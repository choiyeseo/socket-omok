// ê²½ë¡œ: src/client.c
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <unistd.h>
#include <sys/select.h> 

#define SOCK_PATH "/tmp/omok.sock"
#define BOARD_SIZE 15

// í´ë¼ì´ì–¸íŠ¸ ë¡œì»¬ ë³´ë“œ
int my_board[BOARD_SIZE][BOARD_SIZE];

void init_my_board() {
    memset(my_board, 0, sizeof(my_board));
}

// UI ê·¸ë¦¬ê¸° í•¨ìˆ˜
void draw_board() {
    // í™”ë©´ í´ë¦¬ì–´ (ANSI Escape code)
    printf("\033[2J\033[1;1H"); 
    
    printf("   ");
    for (int i = 0; i < BOARD_SIZE; i++) printf("%2d ", i);
    printf("\n");

    for (int i = 0; i < BOARD_SIZE; i++) {
        printf("%2d ", i);
        for (int j = 0; j < BOARD_SIZE; j++) {
            if (my_board[i][j] == 0) printf(" . ");
            else if (my_board[i][j] == 1) printf(" O "); // Player 1 (í‘)
            else if (my_board[i][j] == 2) printf(" X "); // Player 2 (ë°±)
        }
        printf("\n");
    }
    printf("\nCommands: exit, restart, x y\n");
}

int read_line(int fd, char* buf, int size) {
    int i = 0;
    char c;
    while (i < size - 1) {
        int n = read(fd, &c, 1);
        if (n <= 0) return n;
        if (c == '\n') {
            buf[i] = '\0';
            return i;
        }
        buf[i++] = c;
    }
    buf[i] = '\0';
    return i;
}

int main() {
    int fd;
    struct sockaddr_un addr;
    char buf[256];
    int game_over = 0;

    init_my_board();

    fd = socket(AF_UNIX, SOCK_STREAM, 0);
    if (fd == -1) {
        perror("socket");
        return 1;
    }

    memset(&addr, 0, sizeof(addr));
    addr.sun_family = AF_UNIX;
    strcpy(addr.sun_path, SOCK_PATH);

    if (connect(fd, (struct sockaddr *)&addr, sizeof(addr)) == -1) {
        perror("connect");
        close(fd);
        return 1;
    }

    // ì ‘ì† ë©”ì‹œì§€ 
    write(fd, "JOIN user2\n", 11);
    printf("Connected. Waiting for opponent...\n");

    while (1) {
        // ë³´ë“œê°€ ë°”ë€” ë•Œë§ˆë‹¤ ë‹¤ì‹œ ê·¸ë¦¼ (ê²Œì„ ì˜¤ë²„ê°€ ì•„ë‹ ë•Œë§Œ)
        if (!game_over) {
            // draw_board(); // ì—¬ê¸°ì„œ ë§¤ë²ˆ ê·¸ë¦¬ë©´ ê¹œë¹¡ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ MOVE ë•Œ ê·¸ë¦¼
        }

        fd_set readfds;
        FD_ZERO(&readfds);
        FD_SET(0, &readfds);
        FD_SET(fd, &readfds);

        int max_fd = fd;

        if (select(max_fd + 1, &readfds, NULL, NULL, NULL) < 0) break;

        // ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹ 
        if (FD_ISSET(fd, &readfds)) {
            int n = read_line(fd, buf, sizeof(buf));
            if (n <= 0) break;

            // ë””ë²„ê¹…ìš© (í•„ìš”í•˜ë©´ ì£¼ì„ ì²˜ë¦¬)
            // printf("[Server] %s\n", buf);

            // 1. MOVE íŒŒì‹± ë° UI ì—…ë°ì´íŠ¸
            // í˜•ì‹: MOVE <player> <x> <y>
            int p, x, y;
            if (strncmp(buf, "MOVE", 4) == 0) {
                if (sscanf(buf + 5, "%d %d %d", &p, &x, &y) == 3) {
                    if (x >= 0 && x < BOARD_SIZE && y >= 0 && y < BOARD_SIZE) {
                        my_board[x][y] = p; // ì¢Œí‘œê³„ ì£¼ì˜ (ì„œë²„ê°€ x,yë¥¼ í–‰,ì—´ë¡œ ì“°ëŠ”ì§€ í™•ì¸ í•„ìš”)
                        draw_board();
                    }
                }
            }

            // 2. RESET ì²˜ë¦¬
            if (strncmp(buf, "RESET", 5) == 0) {
                init_my_board();
                draw_board();
                game_over = 0;
            }

            if (strncmp(buf, "START", 5) == 0) {
                draw_board();
                printf("Game Started!\n");
            }

            if (strncmp(buf, "TURN", 4) == 0) {
                // TURN ë©”ì‹œì§€ê°€ ì˜¤ë©´ ì…ë ¥ í”„ë¡¬í”„íŠ¸ ê°±ì‹ 
                int turn;
                sscanf(buf + 5, "%d", &turn);
                printf(">> TURN Player %d: ", turn);
                fflush(stdout);
            }

            if (strstr(buf, "WIN")) {
                printf("\nğŸ† %s ğŸ†\n", buf);
            }

            if (strstr(buf, "GAME_OVER")) {
                game_over = 1;
                printf("Game Over. Type 'restart' to play again or 'exit'.\n");
            }
        }

        // í‚¤ë³´ë“œ ì…ë ¥
        if (FD_ISSET(0, &readfds)) {
            char input[128];
            if (!fgets(input, sizeof(input), stdin)) break;
            
            input[strcspn(input, "\n")] = 0;
            if (strlen(input) == 0) continue;

            if (strcmp(input, "exit") == 0) {
                write(fd, "EXIT\n", 5);
                break;
            } else if (strcmp(input, "restart") == 0) {
                write(fd, "RESTART\n", 8);
            } else {
                int r, c;
                if (sscanf(input, "%d %d", &r, &c) == 2) {
                    char msg[64];
                    snprintf(msg, sizeof(msg), "MOVE %d %d\n", r, c);
                    write(fd, msg, strlen(msg));
                }
            }
        }
    }

    close(fd);
    return 0;
}
